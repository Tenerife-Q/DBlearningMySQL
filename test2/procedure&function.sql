-- ============================================================================
-- æ•°æ®åº“æœŸæœ«å¤ä¹ ï¼šå­˜å‚¨è¿‡ç¨‹ + å­˜å‚¨å‡½æ•° ä¸“é¡¹è®­ç»ƒ
-- å¤ä¹ ç­–ç•¥ï¼šå…ˆèƒŒæ¨¡æ¿ â†’ ç†è§£å…³é”®è¯ â†’ åšå¡«ç©ºé¢˜ â†’ çœ‹å®Œæ•´è§£æ â†’ æ€»ç»“æ˜“é”™ç‚¹
-- å»ºè®®ç”¨æ—¶ï¼š3-4å°æ—¶
-- ============================================================================
-- ============================================================================
-- ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¨¡æ¿è¯­æ³•é€ŸæŸ¥ï¼ˆè€ƒå‰5åˆ†é’ŸèƒŒè¯µï¼‰
-- ============================================================================
/*
ã€å­˜å‚¨è¿‡ç¨‹æ¨¡æ¿ã€‘
delimiter $$
create procedure è¿‡ç¨‹å(
    in è¾“å…¥å‚æ•° ç±»å‹,
    out è¾“å‡ºå‚æ•° ç±»å‹,
    inout è¾“å…¥è¾“å‡ºå‚æ•° ç±»å‹
)
begin
    -- 1. å£°æ˜å˜é‡
    declare å˜é‡å ç±»å‹ default é»˜è®¤å€¼;
    
    -- 2. å£°æ˜å¼‚å¸¸å¤„ç†å™¨
    declare exit/continue handler for sqlexception/not found/sqlstate 'xxxxx'
    begin
        å¤„ç†é€»è¾‘;
    end;
    
    -- 3. äº‹åŠ¡æ§åˆ¶
    start transaction;
    
    -- 4. ä¸šåŠ¡é€»è¾‘
    select ...  into å˜é‡ from ... where ...;
    if æ¡ä»¶ then ...  end if;
    update/insert/delete ... ;
    
    -- 5. æäº¤/å›æ»š
    commit / rollback;
end$$
delimiter ;

-- è°ƒç”¨æ–¹å¼
call è¿‡ç¨‹å(å‚æ•°1, @è¾“å‡ºå˜é‡, å‚æ•°3);
select @è¾“å‡ºå˜é‡;
*/
/*
ã€å­˜å‚¨å‡½æ•°æ¨¡æ¿ã€‘
delimiter $$
create function å‡½æ•°å(å‚æ•°å ç±»å‹)
returns è¿”å›ç±»å‹
[deterministic / not deterministic]
[reads sql data / modifies sql data / no sql]
begin
    -- 1. å£°æ˜å˜é‡
    declare å˜é‡å ç±»å‹;
    
    -- 2. ä¸šåŠ¡é€»è¾‘
    select ... into å˜é‡ from ...  where ...;
    
    -- 3. è¿”å›å€¼ï¼ˆå¿…é¡»ï¼‰
    return å˜é‡/è¡¨è¾¾å¼;
end$$
delimiter ;

-- è°ƒç”¨æ–¹å¼
select å‡½æ•°å(å‚æ•°);
select * from table where å‡½æ•°å(å­—æ®µ) > 100;
*/
/*
ã€æ¸¸æ ‡æ¨¡æ¿ï¼ˆåœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼‰ã€‘
begin
    -- 1. å£°æ˜æ¥æ”¶å˜é‡
    declare v_var1 ç±»å‹;
    declare v_done int default 0;
    
    -- 2. å£°æ˜æ¸¸æ ‡
    declare æ¸¸æ ‡å cursor for selectè¯­å¥;
    
    -- 3. å£°æ˜not foundå¤„ç†å™¨
    declare continue handler for not found set v_done = 1;
    
    -- 4. æ‰“å¼€æ¸¸æ ‡
    open æ¸¸æ ‡å;
    
    -- 5. å¾ªç¯è¯»å–
    read_loop:  loop
        fetch æ¸¸æ ‡å into v_var1, ... ;
        if v_done = 1 then
            leave read_loop;
        end if;
        -- å¤„ç†æ•°æ®
    end loop;
    
    -- 6. å…³é—­æ¸¸æ ‡
    close æ¸¸æ ‡å;
end;
*/-- ============================================================================
-- ç¬¬äºŒéƒ¨åˆ†ï¼šå…³é”®è¯è¯¦è§£ï¼ˆæ˜“æ··æ·†ç‚¹é‡ç‚¹æ ‡æ³¨âš ï¸ï¼‰
-- ============================================================================
/*
ã€ä¸€ã€å­˜å‚¨è¿‡ç¨‹å‚æ•°ç±»å‹ã€‘
+--------+----------+----------+----------------------------------------+
| ç±»å‹   | èƒ½è¾“å…¥   | èƒ½è¾“å‡º   | ä½¿ç”¨åœºæ™¯                               |
+--------+----------+----------+----------------------------------------+
| in     | âœ…       | âŒ       | åªéœ€è¦ä¼ å…¥å‚æ•°ï¼ˆå¦‚æŸ¥è¯¢æ¡ä»¶ï¼‰           |
| out    | âŒ       | âœ…       | åªéœ€è¦è¿”å›ç»“æœï¼ˆå¦‚ç»Ÿè®¡æ•°é‡ï¼‰           |
| inout  | âœ…       | âœ…       | éœ€è¦ä¿®æ”¹å‚æ•°æœ¬èº«ï¼ˆå¦‚åˆ†æ•°è½¬ç­‰çº§ï¼‰       |
+--------+----------+----------+----------------------------------------+

âš ï¸ æ˜“é”™ç‚¹1ï¼šoutå‚æ•°åœ¨è¿‡ç¨‹å†…éƒ¨å¯ä»¥ç›´æ¥èµ‹å€¼ï¼Œä¸éœ€è¦å…ˆä¼ å…¥åˆå§‹å€¼
âš ï¸ æ˜“é”™ç‚¹2ï¼šè°ƒç”¨æ—¶outå‚æ•°å¿…é¡»ç”¨@å˜é‡ï¼Œä¸èƒ½ç”¨å¸¸é‡

ç¤ºä¾‹ï¼š
call proc(100, @result, @status);  -- âœ… æ­£ç¡®
call proc(100, result, status);     -- âŒ é”™è¯¯ï¼šoutå‚æ•°å¿…é¡»å¸¦@
*/
/*
ã€äºŒã€å­˜å‚¨å‡½æ•°å‚æ•°ç±»å‹ã€‘
âš ï¸ é‡è¦ï¼šå­˜å‚¨å‡½æ•°åªèƒ½æœ‰inå‚æ•°ï¼ˆè€Œä¸”inå¯ä»¥çœç•¥ä¸å†™ï¼‰

é”™è¯¯ç¤ºä¾‹ï¼š
create function func(out param int) ...  -- âŒ å‡½æ•°ä¸èƒ½æœ‰outå‚æ•°

æ­£ç¡®ç¤ºä¾‹ï¼š
create function func(param int) ...     -- âœ… é»˜è®¤å°±æ˜¯in
create function func(in param int) ...  -- âœ… æ˜¾å¼å†™inä¹Ÿå¯ä»¥
*/
/*
ã€ä¸‰ã€å­˜å‚¨å‡½æ•°ç‰¹æ€§å£°æ˜ã€‘
+--------------------+----------------------------------+------------------------+
| ç‰¹æ€§               | å«ä¹‰                             | ä½¿ç”¨åœºæ™¯               |
+--------------------+----------------------------------+------------------------+
| deterministic      | ç›¸åŒè¾“å…¥â†’ç›¸åŒè¾“å‡º                | æ•°å­¦è®¡ç®—ã€ç­‰çº§åˆ¤æ–­     |
| not deterministic  | ç›¸åŒè¾“å…¥â†’å¯èƒ½ä¸åŒè¾“å‡ºï¼ˆé»˜è®¤ï¼‰    | æ¶‰åŠnow()/rand()/æŸ¥åº“  |
| reads sql data     | åŒ…å«selectæŸ¥è¯¢                   | æŸ¥è¯¢æ•°æ®åº“å¹¶è¿”å›       |
| modifies sql data  | åŒ…å«update/insert/delete         | ä¸æ¨èåœ¨å‡½æ•°ä¸­ç”¨       |
| no sql             | æ²¡æœ‰sqlè¯­å¥                      | çº¯é€»è¾‘è®¡ç®—             |
+--------------------+----------------------------------+------------------------+

âš ï¸ æ˜“é”™ç‚¹3ï¼šreturnsï¼ˆæœ‰sï¼‰æ˜¯å£°æ˜ç±»å‹ï¼Œreturnï¼ˆæ— sï¼‰æ˜¯è¿”å›å€¼
âš ï¸ æ˜“é”™ç‚¹4ï¼šå‡½æ•°å¿…é¡»æœ‰returnè¯­å¥ï¼Œè¿‡ç¨‹å¯ä»¥æ²¡æœ‰è¿”å›å€¼
âš ï¸ æ˜“é”™ç‚¹5ï¼šreads sql dataå’Œdeterministicå¯ä»¥åŒæ—¶å‡ºç°

æ­£ç¡®ç»„åˆç¤ºä¾‹ï¼š
create function get_avg(id int)
returns decimal
not deterministic  -- å› ä¸ºæ•°æ®å¯èƒ½å˜åŒ–
reads sql data     -- å› ä¸ºæœ‰selectæŸ¥è¯¢
begin
    declare avg_val decimal;
    select avg(score) into avg_val from sc where student_id = id;
    return avg_val;
end;
*/
/*
ã€å››ã€å¼‚å¸¸å¤„ç†å™¨ç±»å‹ã€‘
+----------+------------------+----------------------------------+
| ç±»å‹     | é‡åˆ°å¼‚å¸¸å       | ä½¿ç”¨åœºæ™¯                         |
+----------+------------------+----------------------------------+
| exit     | ç«‹å³é€€å‡ºè¿‡ç¨‹/å‡½æ•°| ç³»ç»Ÿé”™è¯¯ã€æ— æ³•æ¢å¤çš„é”™è¯¯         |
| continue | ç»§ç»­æ‰§è¡Œåç»­ä»£ç  | ä¸šåŠ¡é”™è¯¯ã€éœ€è¦è®°å½•æ—¥å¿—çš„é”™è¯¯     |
+----------+------------------+----------------------------------+

âš ï¸ æ˜“é”™ç‚¹6ï¼šæ¸¸æ ‡ç»“æŸå¿…é¡»ç”¨continue handlerï¼Œä¸èƒ½ç”¨exit
âš ï¸ æ˜“é”™ç‚¹7ï¼šå¤šä¸ªhandlerå¯ä»¥å…±å­˜ï¼Œä¼˜å…ˆçº§ï¼šå…·ä½“sqlstate > not found > sqlexception

æ­£ç¡®ç¤ºä¾‹ï¼š
declare continue handler for not found set v_not_found = 1;     -- å¤„ç†æŸ¥è¯¢æ— ç»“æœ
declare continue handler for sqlstate '23000' set v_error = 1;  -- å¤„ç†çº¦æŸè¿å
declare exit handler for sqlexception begin rollback; end;      -- å¤„ç†å…¶ä»–æ‰€æœ‰é”™è¯¯
*/
/*
ã€äº”ã€å¼‚å¸¸ç±»å‹ã€‘
+-------------------+-------------------------------+
| å¼‚å¸¸ç±»å‹          | è§¦å‘åœºæ™¯                      |
+-------------------+-------------------------------+
| sqlexception      | æ‰€æœ‰sqlé”™è¯¯ï¼ˆè¯­æ³•ã€æƒé™ç­‰ï¼‰   |
| not found         | select intoæ— ç»“æœã€æ¸¸æ ‡è¯»å®Œ   |
| sqlstate '23000'  | çº¦æŸè¿åï¼ˆä¸»é”®/å¤–é”®/checkï¼‰   |
| sqlstate '45000'  | ç”¨æˆ·è‡ªå®šä¹‰é”™è¯¯ï¼ˆsignalæŠ›å‡ºï¼‰  |
+-------------------+-------------------------------+

âš ï¸ æ˜“é”™ç‚¹8ï¼šsqlstateåé¢çš„é”™è¯¯ç å¿…é¡»ç”¨å¼•å·ï¼Œæ˜¯å­—ç¬¦ä¸²ä¸æ˜¯æ•°å­—
*/
/*
ã€å…­ã€äº‹åŠ¡æ§åˆ¶ã€‘
start transaction; -- å¼€å¯äº‹åŠ¡
commit;            -- æäº¤äº‹åŠ¡ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰
rollback;          -- å›æ»šäº‹åŠ¡ï¼ˆæ’¤é”€æ‰€æœ‰æ“ä½œï¼‰

âš ï¸ æ˜“é”™ç‚¹9ï¼šrollbackåªå›æ»šæ•°æ®åº“æ“ä½œï¼ˆupdate/insert/deleteï¼‰ï¼Œä¸å›æ»šå˜é‡èµ‹å€¼ï¼ˆsetï¼‰
âš ï¸ æ˜“é”™ç‚¹10ï¼šè§¦å‘å™¨ä¸­ä¸èƒ½æ˜¾å¼è°ƒç”¨start transaction/commit/rollback

ç¤ºä¾‹ï¼š
start transaction;
update account set balance = 100 where id = 1;
set @msg = 'å·²æ›´æ–°';
rollback;
-- ç»“æœï¼šbalanceæ¢å¤åŸå€¼ï¼Œä½†@msgä»ç„¶æ˜¯'å·²æ›´æ–°'
*/
/*
ã€ä¸ƒã€æ¸¸æ ‡å…³é”®å­—ã€‘
declare æ¸¸æ ‡å cursor for ...   -- å£°æ˜æ¸¸æ ‡
open æ¸¸æ ‡å                    -- æ‰“å¼€æ¸¸æ ‡ï¼ˆæ‰§è¡ŒæŸ¥è¯¢ï¼‰
fetch æ¸¸æ ‡å into å˜é‡åˆ—è¡¨     -- è¯»å–ä¸€è¡Œæ•°æ®
close æ¸¸æ ‡å                   -- å…³é—­æ¸¸æ ‡ï¼ˆé‡Šæ”¾èµ„æºï¼‰
leave å¾ªç¯æ ‡ç­¾                 -- é€€å‡ºå¾ªç¯

âš ï¸ æ˜“é”™ç‚¹11ï¼šfetchçš„å˜é‡é¡ºåºå¿…é¡»ä¸selectçš„åˆ—é¡ºåºä¸€è‡´
âš ï¸ æ˜“é”™ç‚¹12ï¼šæ¸¸æ ‡å£°æ˜å¿…é¡»åœ¨handlerå£°æ˜ä¹‹å‰
*/
/*
ã€å…«ã€å£°æ˜é¡ºåºï¼ˆmysqlå¼ºåˆ¶è¦æ±‚ï¼‰ã€‘
begin
    -- é¡ºåº1ï¼šæ™®é€šå˜é‡
    declare v_var int;
    
    -- é¡ºåº2ï¼šæ¸¸æ ‡
    declare cur_name cursor for ... ;
    
    -- é¡ºåº3ï¼šå¼‚å¸¸å¤„ç†å™¨
    declare continue handler for ...;
    
    -- é¡ºåº4ï¼šå¯æ‰§è¡Œè¯­å¥ï¼ˆopen/select/updateç­‰ï¼‰
    open cur_name;
end;

âš ï¸ æ˜“é”™ç‚¹13ï¼šå¦‚æœé¡ºåºé”™è¯¯ï¼Œä¼šæŠ¥"syntax error"
*/-- ============================================================================
-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¡«ç©ºé¢˜è®­ç»ƒï¼ˆä»æ˜“åˆ°éš¾ï¼Œå…±10é¢˜ï¼‰
-- ============================================================================
-- ----------------------------------------------------------------------------
-- ã€åŸºç¡€é¢˜1ã€‘å­˜å‚¨è¿‡ç¨‹å‚æ•°ç±»å‹ï¼ˆéš¾åº¦ï¼šâ­ï¼‰
-- è€ƒç‚¹ï¼šin/out/inoutçš„åŸºæœ¬ç”¨æ³•
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šåˆ›å»ºä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œè®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œä¸å·®
è¦æ±‚ï¼šä¼ å…¥ä¸¤ä¸ªæ•°aå’Œbï¼Œè¿”å›å®ƒä»¬çš„å’Œ(sum)ä¸å·®(diff)
*/

delimiter $$
CREATE PROCEDURE calc_sum_diff ( _____ p_a INT, -- [å¡«ç©º1] è¾“å…¥å‚æ•°a
  _____ p_b INT, -- [å¡«ç©º2] è¾“å…¥å‚æ•°b
  _____ p_sum INT, -- [å¡«ç©º3] è¾“å‡ºå‚æ•°sum
  _____ p_diff INT -- [å¡«ç©º4] è¾“å‡ºå‚æ•°diff
  ) BEGIN
  
  SET p_sum = p_a + p_b;
  
  SET p_diff = p_a - p_b;
  
END $$delimiter;-- æµ‹è¯•è°ƒç”¨ï¼ˆè¯·åœ¨å®Œæˆå¡«ç©ºåå–æ¶ˆæ³¨é‡Šæµ‹è¯•ï¼‰
-- call calc_sum_diff(10, 3, @s, @d);
-- select @s as å’Œ, @d as å·®;
-- ----------------------------------------------------------------------------
-- ã€åŸºç¡€é¢˜2ã€‘å­˜å‚¨å‡½æ•°è¿”å›å€¼ï¼ˆéš¾åº¦ï¼šâ­ï¼‰
-- è€ƒç‚¹ï¼šreturns vs returnï¼Œå‡½æ•°ç‰¹æ€§å£°æ˜
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šåˆ›å»ºå‡½æ•°è®¡ç®—åœ†çš„é¢ç§¯
è¦æ±‚ï¼šä¼ å…¥åŠå¾„ï¼Œè¿”å›é¢ç§¯ï¼ˆÏ€å–3.14ï¼‰
*/

delimiter $$
CREATE FUNCTION calc_circle_area (
radius DECIMAL ( 10, 2 )) _______ DECIMAL ( 10, 2 ) -- [å¡«ç©º5] å£°æ˜è¿”å›ç±»å‹ï¼ˆæœ‰sï¼‰
_______ -- [å¡«ç©º6] ç‰¹æ€§å£°æ˜ï¼šç›¸åŒåŠå¾„â†’ç›¸åŒé¢ç§¯
BEGIN
    _______ 3.14 * radius * radius;-- [å¡«ç©º7] è¿”å›å€¼ï¼ˆæ— sï¼‰
  
END $$delimiter;-- æµ‹è¯•è°ƒç”¨
-- select calc_circle_area(5) as é¢ç§¯;
-- ----------------------------------------------------------------------------
-- ã€åŸºç¡€é¢˜3ã€‘å¼‚å¸¸å¤„ç†å™¨ç±»å‹ï¼ˆéš¾åº¦ï¼šâ­â­ï¼‰
-- è€ƒç‚¹ï¼šexit vs continueï¼Œsqlexception vs not found
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹æŸ¥è¯¢ç”¨æˆ·ä½™é¢
è¦æ±‚ï¼šå¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›0ï¼›å¦‚æœå‘ç”Ÿç³»ç»Ÿé”™è¯¯ï¼Œç«‹å³é€€å‡ºå¹¶è¿”å›-1
*/

delimiter $$
CREATE PROCEDURE get_balance ( IN p_user_id INT, OUT p_balance DECIMAL ( 10, 2 ) ) BEGIN-- [å¡«ç©º8] å£°æ˜not foundå¤„ç†å™¨ï¼šç”¨æˆ·ä¸å­˜åœ¨æ—¶è®¾ç½®ä½™é¢ä¸º0
  DECLARE
    _______ HANDLER FOR _______ 
    SET p_balance = 0;-- [å¡«ç©º9] å£°æ˜sqlexceptionå¤„ç†å™¨ï¼šç³»ç»Ÿé”™è¯¯æ—¶ç«‹å³é€€å‡º
  DECLARE
    _______ HANDLER FOR _______ BEGIN
      
      SET p_balance = - 1;
    
  END;
  SELECT
    balance INTO p_balance 
  FROM
    users 
  WHERE
    user_id = p_user_id;
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€ä¸­ç­‰é¢˜4ã€‘äº‹åŠ¡æ§åˆ¶ï¼ˆéš¾åº¦ï¼šâ­â­ï¼‰
-- è€ƒç‚¹ï¼šstart transactionã€commitã€rollback
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šè½¬è´¦æ“ä½œ
è¦æ±‚ï¼šä»è´¦æˆ·aè½¬è´¦åˆ°è´¦æˆ·bï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯åˆ™å›æ»š
*/

delimiter $$
CREATE PROCEDURE transfer_money ( IN p_from INT, IN p_to INT, IN p_amount DECIMAL ( 10, 2 ), OUT p_result VARCHAR ( 50 ) ) BEGIN
  DECLARE
    v_error INT DEFAULT 0;
  DECLARE
  CONTINUE HANDLER FOR SQLEXCEPTION 
    SET v_error = 1;-- [å¡«ç©º10] å¼€å¯äº‹åŠ¡
  _______ _______;-- æ‰£æ¬¾
  UPDATE accounts 
  SET balance = balance - p_amount 
  WHERE
    id = p_from;-- å…¥è´¦
  UPDATE accounts 
  SET balance = balance + p_amount 
  WHERE
    id = p_to;-- [å¡«ç©º11] æ£€æŸ¥é”™è¯¯ï¼šå¦‚æœæœ‰é”™åˆ™å›æ»šï¼Œå¦åˆ™æäº¤
  IF
    v_error = 1 THEN
      _______;-- å›æ»š
    
    SET p_result = 'fail';
    ELSE _______;-- æäº¤
    
    SET p_result = 'success';
    
  END IF;
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€ä¸­ç­‰é¢˜5ã€‘å‡½æ•°ç‰¹æ€§å£°æ˜ï¼ˆéš¾åº¦ï¼šâ­â­ï¼‰
-- è€ƒç‚¹ï¼šreads sql dataã€not deterministic
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šåˆ›å»ºå‡½æ•°æŸ¥è¯¢å­¦ç”Ÿå¹³å‡åˆ†
è¦æ±‚ï¼šä¼ å…¥å­¦ç”Ÿidï¼Œè¿”å›å¹³å‡åˆ†ï¼ˆå¦‚æœæ²¡æœ‰æˆç»©è¿”å›0ï¼‰
*/

delimiter $$
CREATE FUNCTION get_student_avg ( stu_id INT ) RETURNS DECIMAL ( 5, 2 ) _______ -- [å¡«ç©º12] ç‰¹æ€§å£°æ˜ï¼šåŒ…å«selectæŸ¥è¯¢
_______ -- [å¡«ç©º13] ç‰¹æ€§å£°æ˜ï¼šæ•°æ®å¯èƒ½å˜åŒ–
BEGIN
  DECLARE
    avg_score DECIMAL ( 5, 2 );
  SELECT
    avg( score ) INTO avg_score 
  FROM
    sc 
  WHERE
    student_id = stu_id;
  RETURN ifnull( avg_score, 0 );
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€ä¸­ç­‰é¢˜6ã€‘çº¦æŸé”™è¯¯æ•è·ï¼ˆéš¾åº¦ï¼šâ­â­â­ï¼‰
-- è€ƒç‚¹ï¼šsqlstate '23000'ï¼Œcontinue handler
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šæ›´æ–°å‘˜å·¥è–ªèµ„
è¦æ±‚ï¼šå¦‚æœæ–°è–ªèµ„è¿åçº¦æŸï¼ˆå¦‚ä½äºæœ€ä½å·¥èµ„3000ï¼‰ï¼Œæ•è·é”™è¯¯å¹¶è¿”å›å¤±è´¥ä¿¡æ¯
*/

delimiter $$
CREATE PROCEDURE update_salary ( IN p_emp_id INT, IN p_new_salary DECIMAL ( 10, 2 ), OUT p_status VARCHAR ( 50 ) ) BEGIN
  DECLARE
    v_constraint_error INT DEFAULT 0;-- [å¡«ç©º14] å£°æ˜çº¦æŸè¿åå¤„ç†å™¨ï¼ˆsqlstate '23000'ï¼‰
  DECLARE
    CONTINUE HANDLER FOR SQLSTATE '_______' 
    SET v_constraint_error = 1;
  START TRANSACTION;
  UPDATE employees 
  SET salary = p_new_salary 
  WHERE
    emp_id = p_emp_id;-- [å¡«ç©º15] æ£€æŸ¥æ˜¯å¦è¿åçº¦æŸ
  IF
    _______ = 1 THEN
      ROLLBACK;
    
    SET p_status = 'è–ªèµ„è¿åçº¦æŸ';
    ELSE COMMIT;
    
    SET p_status = 'æ›´æ–°æˆåŠŸ';
    
  END IF;
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€ä¸­ç­‰é¢˜7ã€‘inoutå‚æ•°ï¼ˆéš¾åº¦ï¼šâ­â­â­ï¼‰
-- è€ƒç‚¹ï¼šå‚æ•°æ—¢è¾“å…¥åˆè¾“å‡º
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šåˆ†æ•°è½¬ç­‰çº§
è¦æ±‚ï¼šä¼ å…¥åˆ†æ•°å­—ç¬¦ä¸²ï¼ˆå¦‚'85'ï¼‰ï¼Œè½¬æ¢æˆç­‰çº§ï¼ˆå¦‚'è‰¯å¥½'ï¼‰å¹¶è¿”å›
*/

delimiter $$
CREATE PROCEDURE score_to_grade ( _______ p_value VARCHAR ( 20 ) -- [å¡«ç©º16] æ—¢è¾“å…¥åˆè¾“å‡ºçš„å‚æ•°ç±»å‹
  ) BEGIN
  DECLARE
    v_score INT;
  
  SET v_score = cast( p_value AS signed );-- [å¡«ç©º17] ä½¿ç”¨caseåˆ¤æ–­ç­‰çº§
  
  SET p_value = _______ 
  WHEN v_score >= 90 THEN
  'ä¼˜ç§€' 
  WHEN v_score >= 80 THEN
  'è‰¯å¥½' 
  WHEN v_score >= 60 THEN
  'åŠæ ¼' ELSE 'ä¸åŠæ ¼' _______;-- [å¡«ç©º18] caseç»“æŸå…³é”®å­—
  
END $$delimiter;-- æµ‹è¯•è°ƒç”¨
-- set @grade = '85';
-- call score_to_grade(@grade);
-- select @grade;
-- ----------------------------------------------------------------------------
-- ã€éš¾é¢˜8ã€‘æ¸¸æ ‡åŸºç¡€ï¼ˆéš¾åº¦ï¼šâ­â­â­ï¼‰
-- è€ƒç‚¹ï¼šcursorã€openã€fetchã€closeã€not found
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šéå†æ‰€æœ‰å­¦ç”Ÿå¹¶è¾“å‡ºå§“å
è¦æ±‚ï¼šä½¿ç”¨æ¸¸æ ‡é€è¡Œè¯»å–studentè¡¨ä¸­çš„å§“å
*/

delimiter $$
CREATE PROCEDURE print_all_students () BEGIN
  DECLARE
    v_name VARCHAR ( 50 );
  DECLARE
    v_done INT DEFAULT 0;-- [å¡«ç©º19] å£°æ˜æ¸¸æ ‡
  DECLARE
    cur_students _______ FOR SELECT
    student_name 
  FROM
    student;-- [å¡«ç©º20] å£°æ˜not foundå¤„ç†å™¨
  DECLARE
    CONTINUE _______ FOR _______ 
    SET v_done = 1;-- [å¡«ç©º21] æ‰“å¼€æ¸¸æ ‡
  _______ cur_students;
  read_loop :
  LOOP-- [å¡«ç©º22] ä»æ¸¸æ ‡è¯»å–æ•°æ®
    _______ cur_students INTO v_name;
    IF
      v_done = 1 THEN
        _______ read_loop;-- [å¡«ç©º23] é€€å‡ºå¾ªç¯
      
    END IF;
    SELECT
      v_name;
    
  END LOOP;-- [å¡«ç©º24] å…³é—­æ¸¸æ ‡
  _______ cur_students;
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€éš¾é¢˜9ã€‘ç»¼åˆåº”ç”¨ï¼ˆéš¾åº¦ï¼šâ­â­â­â­ï¼‰
-- è€ƒç‚¹ï¼šäº‹åŠ¡+å¼‚å¸¸å¤„ç†+å¤šæ¬¡æŸ¥è¯¢+ä¸šåŠ¡é€»è¾‘
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šä¼šå‘˜ç§¯åˆ†å…‘æ¢ç³»ç»Ÿ
è¦æ±‚ï¼š
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å……è¶³
3. æ£€æŸ¥å•†å“åº“å­˜æ˜¯å¦å……è¶³
4. ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½è¦å›æ»šå¹¶è¿”å›å…·ä½“é”™è¯¯ç 
çŠ¶æ€ç ï¼š0=æˆåŠŸ, -1=ç”¨æˆ·ä¸å­˜åœ¨, -2=ç§¯åˆ†ä¸è¶³, -3=åº“å­˜ä¸è¶³, -99=ç³»ç»Ÿé”™è¯¯
*/

delimiter $$
CREATE PROCEDURE exchange_product ( IN p_user_id INT, IN p_product_id INT, OUT p_status INT, OUT p_message VARCHAR ( 100 ) ) BEGIN-- [å¡«ç©º25] å£°æ˜3ä¸ªå˜é‡ï¼šç”¨æˆ·ç§¯åˆ†ã€å•†å“ä»·æ ¼ã€å•†å“åº“å­˜
  DECLARE
    v_user_points INT DEFAULT 0;
  DECLARE
    v_product_price INT DEFAULT 0;
  DECLARE
    v_product_stock _______ DEFAULT 0;-- å•†å“åº“å­˜
  DECLARE
    v_not_found INT DEFAULT 0;-- [å¡«ç©º26] å£°æ˜not foundå¤„ç†å™¨
  DECLARE
    _______ HANDLER FOR NOT found 
    SET v_not_found = 1;
  DECLARE
  EXIT HANDLER FOR SQLEXCEPTION BEGIN
      ROLLBACK;
    
    SET p_status = - 99;
    
    SET p_message = 'ç³»ç»Ÿå¼‚å¸¸';
    
  END;-- [å¡«ç©º27] å¼€å¯äº‹åŠ¡
  _______ TRANSACTION;-- æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†
  SELECT
    points INTO v_user_points 
  FROM
    users 
  WHERE
    user_id = p_user_id;-- [å¡«ç©º28] æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  IF
    _______ = 1 THEN
      ROLLBACK;
    
    SET p_status = - 1;
    
    SET p_message = 'ç”¨æˆ·ä¸å­˜åœ¨';
    ELSE 
      SET v_not_found = 0;-- é‡ç½®æ ‡å¿—
-- [å¡«ç©º29] æŸ¥è¯¢å•†å“ä»·æ ¼å’Œåº“å­˜
    SELECT
      point_price,
      stock INTO _______,
      v_product_stock 
    FROM
      products 
    WHERE
      product_id = p_product_id;
    IF
      v_not_found = 1 THEN
        ROLLBACK;
      
      SET p_status = - 3;
      
      SET p_message = 'å•†å“ä¸å­˜åœ¨';
      ELSE -- [å¡«ç©º30] æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å……è¶³
      IF
        v_user_points < _______ THEN
          ROLLBACK;
        
        SET p_status = - 2;
        
        SET p_message = 'ç§¯åˆ†ä¸è¶³';
        ELSE
        IF
          v_product_stock < 1 THEN
            ROLLBACK;
          
          SET p_status = - 3;
          
          SET p_message = 'åº“å­˜ä¸è¶³';
          ELSE -- æ‰£å‡ç§¯åˆ†
          UPDATE users 
          SET points = points - v_product_price 
          WHERE
            user_id = p_user_id;-- æ‰£å‡åº“å­˜
          UPDATE products 
          SET stock = stock - 1 
          WHERE
            product_id = p_product_id;-- [å¡«ç©º31] æäº¤äº‹åŠ¡
          _______;
          
          SET p_status = 0;
          
          SET p_message = 'å…‘æ¢æˆåŠŸ';
          
        END IF;
        
      END IF;
      
    END IF;
    
  END IF;
  
END $$delimiter;-- ----------------------------------------------------------------------------
-- ã€éš¾é¢˜10ã€‘æ¸¸æ ‡ç»¼åˆåº”ç”¨ï¼ˆéš¾åº¦ï¼šâ­â­â­â­â­ï¼‰
-- è€ƒç‚¹ï¼šæ¸¸æ ‡+äº‹åŠ¡+å¼‚å¸¸å¤„ç†+æ‰¹é‡æ›´æ–°
-- ----------------------------------------------------------------------------
/*
é¢˜ç›®ï¼šæ‰¹é‡å¤„ç†é€¾æœŸå›¾ä¹¦
è¦æ±‚ï¼š
1. éå†æ‰€æœ‰é€¾æœŸä¸”æœªå¤„ç†çš„å€Ÿé˜…è®°å½•
2. è®¡ç®—ç½šæ¬¾ï¼ˆæ¯å¤©0.5å…ƒï¼‰å¹¶æ‰£é™¤ç”¨æˆ·ä½™é¢
3. æ ‡è®°å›¾ä¹¦å’Œå€Ÿé˜…è®°å½•çŠ¶æ€
4. è¿”å›å¤„ç†çš„è®°å½•æ•°é‡ï¼ˆå¤±è´¥è¿”å›-1ï¼‰
*/

delimiter $$
CREATE PROCEDURE process_overdue_books ( OUT p_processed_count INT ) BEGIN
  DECLARE
    v_borrow_id INT;
  DECLARE
    v_user_id INT;
  DECLARE
    v_book_id INT;
  DECLARE
    v_days_overdue INT;
  DECLARE
    v_done INT DEFAULT 0;-- [å¡«ç©º32] å£°æ˜æ¸¸æ ‡ï¼ˆæŸ¥è¯¢é€¾æœŸè®°å½•ï¼‰
  DECLARE
    cur_overdue CURSOR FOR SELECT
    borrow_id,
    user_id,
    book_id,
    datediff( now(), due_date ) AS days_overdue 
  FROM
    borrows 
  WHERE
    due_date < now() 
    AND STATUS = 'borrowed';-- [å¡«ç©º33] å£°æ˜not foundå¤„ç†å™¨
  DECLARE
    CONTINUE HANDLER FOR _______ 
    SET v_done = 1;
  DECLARE
  EXIT HANDLER FOR SQLEXCEPTION BEGIN
      ROLLBACK;
    
    SET p_processed_count = - 1;
    
  END;
  
  SET p_processed_count = 0;
  START TRANSACTION;-- [å¡«ç©º34] æ‰“å¼€æ¸¸æ ‡
  _______ cur_overdue;-- [å¡«ç©º35] å¼€å§‹å¾ªç¯
  read_loop : _______ -- [å¡«ç©º36] è¯»å–ä¸€è¡Œæ•°æ®
  _______ cur_overdue INTO v_borrow_id,
  v_user_id,
  v_book_id,
  v_days_overdue;-- [å¡«ç©º37] æ£€æŸ¥æ˜¯å¦è¯»å®Œ
  IF
    v_done = 1 THEN
      _______ read_loop;-- é€€å‡ºå¾ªç¯
    
  END IF;-- è®¡ç®—ç½šæ¬¾
  UPDATE users 
  SET balance = balance - ( v_days_overdue * 0.5 ) 
  WHERE
    user_id = v_user_id;-- æ ‡è®°å›¾ä¹¦çŠ¶æ€
  UPDATE books 
  SET STATUS = 'overdue' 
  WHERE
    book_id = v_book_id;-- æ ‡è®°å€Ÿé˜…è®°å½•
  UPDATE borrows 
  SET STATUS = 'overdue_processed' 
  WHERE
    borrow_id = v_borrow_id;
  
  SET p_processed_count = p_processed_count + 1;-- [å¡«ç©º38] ç»“æŸå¾ªç¯
  _______
  LOOP
      ;-- [å¡«ç©º39] å…³é—­æ¸¸æ ‡
    _______ cur_overdue;
    COMMIT;
    
  END $$delimiter;-- ============================================================================
-- ç¬¬å››éƒ¨åˆ†ï¼šå®Œæ•´ç­”æ¡ˆä¸è¯¦è§£
-- ============================================================================
/*
ã€åŸºç¡€é¢˜1ç­”æ¡ˆã€‘
[å¡«ç©º1] in
[å¡«ç©º2] in
[å¡«ç©º3] out
[å¡«ç©º4] out

è§£æï¼š
- p_aå’Œp_bæ˜¯è¾“å…¥å‚æ•°ï¼Œä½¿ç”¨in
- p_sumå’Œp_diffæ˜¯è¾“å‡ºå‚æ•°ï¼Œä½¿ç”¨out
- outå‚æ•°åœ¨è¿‡ç¨‹å†…éƒ¨å¯ä»¥ç›´æ¥èµ‹å€¼
*/
/*
ã€åŸºç¡€é¢˜2ç­”æ¡ˆã€‘
[å¡«ç©º5] returns
[å¡«ç©º6] deterministic
[å¡«ç©º7] return

è§£æï¼š
- returnsï¼ˆæœ‰sï¼‰ç”¨äºå£°æ˜è¿”å›ç±»å‹
- deterministicè¡¨ç¤ºç›¸åŒè¾“å…¥äº§ç”Ÿç›¸åŒè¾“å‡ºï¼ˆåœ†é¢ç§¯æ˜¯ç¡®å®šçš„ï¼‰
- returnï¼ˆæ— sï¼‰ç”¨äºè¿”å›å…·ä½“å€¼
- âš ï¸ è®°å¿†æŠ€å·§ï¼šæœ‰så£°æ˜ï¼Œæ— sè¿”å›
*/
/*
ã€åŸºç¡€é¢˜3ç­”æ¡ˆã€‘
[å¡«ç©º8] continue, not found
[å¡«ç©º9] exit, sqlexception

è§£æï¼š
- æŸ¥è¯¢ä¸åˆ°ç”¨æˆ·æ—¶ï¼Œä½¿ç”¨continue handlerç»§ç»­æ‰§è¡Œï¼ˆè®¾ç½®é»˜è®¤å€¼0ï¼‰
- ç³»ç»Ÿé”™è¯¯æ—¶ï¼Œä½¿ç”¨exit handlerç«‹å³é€€å‡º
- not foundä¸“é—¨å¤„ç†select intoæ— ç»“æœçš„æƒ…å†µ
- sqlexceptionæ•è·æ‰€æœ‰sqlé”™è¯¯
*/
/*
ã€ä¸­ç­‰é¢˜4ç­”æ¡ˆã€‘
[å¡«ç©º10] start transaction
[å¡«ç©º11] rollbackï¼ˆç¬¬ä¸€ä¸ªç©ºï¼‰ï¼Œcommitï¼ˆç¬¬äºŒä¸ªç©ºï¼‰

è§£æï¼š
- start transactionå¼€å¯äº‹åŠ¡
- rollbackæ’¤é”€æ‰€æœ‰æ•°æ®åº“æ“ä½œï¼ˆæ‰£æ¬¾å’Œå…¥è´¦ï¼‰
- commitä½¿æ“ä½œæ°¸ä¹…ç”Ÿæ•ˆ
- âš ï¸ æ³¨æ„ï¼šrollbackä¸ä¼šæ’¤é”€å˜é‡èµ‹å€¼ï¼ˆset @var = ... ï¼‰
*/
/*
ã€ä¸­ç­‰é¢˜5ç­”æ¡ˆã€‘
[å¡«ç©º12] reads sql data
[å¡«ç©º13] not deterministic

è§£æï¼š
- å‡½æ•°ä¸­åŒ…å«selectæŸ¥è¯¢ï¼Œå¿…é¡»å£°æ˜reads sql data
- æ•°æ®åº“ä¸­çš„æˆç»©å¯èƒ½å˜åŒ–ï¼Œæ‰€ä»¥æ˜¯not deterministic
- è¿™ä¸¤ä¸ªç‰¹æ€§å¯ä»¥åŒæ—¶ä½¿ç”¨
*/
/*
ã€ä¸­ç­‰é¢˜6ç­”æ¡ˆã€‘
[å¡«ç©º14] 23000
[å¡«ç©º15] v_constraint_error

è§£æï¼š
- sqlstate '23000'ä¸“é—¨æ•è·å®Œæ•´æ€§çº¦æŸè¿åé”™è¯¯
- åŒ…æ‹¬ï¼šä¸»é”®é‡å¤ã€å¤–é”®å†²çªã€checkçº¦æŸå¤±è´¥ã€uniqueå†²çª
- âš ï¸ æ³¨æ„ï¼šé”™è¯¯ç å¿…é¡»ç”¨å¼•å·ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œä¸èƒ½å†™æˆæ•°å­—23000
- ä½¿ç”¨continue handlerç»§ç»­æ‰§è¡Œï¼Œå¯ä»¥è®°å½•æ—¥å¿—æˆ–è®¾ç½®çŠ¶æ€
*/
/*
ã€ä¸­ç­‰é¢˜7ç­”æ¡ˆã€‘
[å¡«ç©º16] inout
[å¡«ç©º17] case
[å¡«ç©º18] end

è§£æï¼š
- inoutå‚æ•°æ—¢å¯ä»¥è¾“å…¥åˆå¯ä»¥è¾“å‡º
- è¿™é‡Œè¾“å…¥åˆ†æ•°å­—ç¬¦ä¸²'85'ï¼Œè¾“å‡ºç­‰çº§'è‰¯å¥½'
- caseè¡¨è¾¾å¼ä»ä¸Šåˆ°ä¸‹åŒ¹é…ï¼ŒåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªä¸ºçœŸçš„æ¡ä»¶å°±è¿”å›
- âš ï¸ æ³¨æ„ï¼šcaseç»“æŸç”¨endï¼Œä¸æ˜¯end case
*/
/*
ã€éš¾é¢˜8ç­”æ¡ˆã€‘
[å¡«ç©º19] cursor
[å¡«ç©º20] handler, not found
[å¡«ç©º21] open
[å¡«ç©º22] fetch
[å¡«ç©º23] leave
[å¡«ç©º24] close

è§£æï¼š
æ¸¸æ ‡äº”æ­¥èµ°ï¼š
1. declare cursorå£°æ˜æ¸¸æ ‡
2. declare handlerå£°æ˜not foundå¤„ç†å™¨
3. openæ‰“å¼€æ¸¸æ ‡ï¼ˆæ‰§è¡ŒæŸ¥è¯¢ï¼‰
4. fetchè¯»å–ä¸€è¡Œæ•°æ®ï¼ˆå¾ªç¯ä¸­è°ƒç”¨ï¼‰
5. closeå…³é—­æ¸¸æ ‡ï¼ˆé‡Šæ”¾èµ„æºï¼‰

âš ï¸ å…³é”®ç‚¹ï¼š
- æ¸¸æ ‡å£°æ˜å¿…é¡»åœ¨handlerä¹‹å‰
- not foundå¤„ç†å™¨å¿…é¡»ç”¨continueï¼ˆä¸èƒ½ç”¨exitï¼‰
- fetchçš„å˜é‡é¡ºåºå¿…é¡»ä¸selectçš„åˆ—é¡ºåºä¸€è‡´
*/
/*
ã€éš¾é¢˜9ç­”æ¡ˆã€‘
[å¡«ç©º25] int
[å¡«ç©º26] continue
[å¡«ç©º27] start
[å¡«ç©º28] v_not_found
[å¡«ç©º29] v_product_price
[å¡«ç©º30] v_product_price
[å¡«ç©º31] commit

è§£æï¼š
è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡å¤„ç†æµç¨‹ï¼š
1. å£°æ˜å˜é‡æ¥æ”¶æŸ¥è¯¢ç»“æœ
2. ä½¿ç”¨not foundå¤„ç†å™¨æ•è·æŸ¥è¯¢å¤±è´¥
3. å¼€å¯äº‹åŠ¡ä¿è¯åŸå­æ€§
4. é€æ­¥éªŒè¯ä¸šåŠ¡æ¡ä»¶ï¼ˆç”¨æˆ·å­˜åœ¨ã€ç§¯åˆ†å……è¶³ã€åº“å­˜å……è¶³ï¼‰
5. ä»»ä½•æ¡ä»¶ä¸æ»¡è¶³éƒ½è¦rollbackå¹¶è®¾ç½®é”™è¯¯ç 
6. æ‰€æœ‰æ¡ä»¶æ»¡è¶³åæ‰§è¡Œupdateå¹¶commit

âš ï¸ é‡éš¾ç‚¹ï¼š
- æ¯æ¬¡select intoå‰è¦é‡ç½®v_not_found = 0
- ä½¿ç”¨åµŒå¥—if-elseé¿å…ä½¿ç”¨leaveæ ‡ç­¾
- rollbackåsetè¯­å¥ä»ä¼šæ‰§è¡Œï¼ˆç”¨äºè¿”å›é”™è¯¯ä¿¡æ¯ï¼‰
*/
/*
ã€éš¾é¢˜10ç­”æ¡ˆã€‘
[å¡«ç©º32] ï¼ˆå·²ç»™å‡ºå®Œæ•´sqlï¼Œæ— éœ€å¡«ç©ºï¼‰
[å¡«ç©º33] not found
[å¡«ç©º34] open
[å¡«ç©º35] loop
[å¡«ç©º36] fetch
[å¡«ç©º37] leave
[å¡«ç©º38] end
[å¡«ç©º39] close

è§£æï¼š
è¿™æ˜¯æ¸¸æ ‡+äº‹åŠ¡+æ‰¹é‡å¤„ç†çš„ç»¼åˆåº”ç”¨ï¼š
1. æ¸¸æ ‡æŸ¥è¯¢æ‰€æœ‰éœ€è¦å¤„ç†çš„è®°å½•
2. åœ¨äº‹åŠ¡ä¸­é€æ¡å¤„ç†
3. æ¯æ¡è®°å½•æ‰§è¡Œ3ä¸ªupdateæ“ä½œï¼ˆæ‰£æ¬¾ã€æ ‡è®°å›¾ä¹¦ã€æ ‡è®°å€Ÿé˜…ï¼‰
4. è®°å½•å¤„ç†æ•°é‡
5. å¦‚æœä¸­é€”å‘ç”Ÿé”™è¯¯ï¼Œexit handlerä¼šå›æ»šæ‰€æœ‰æ“ä½œ

âš ï¸ æ ¸å¿ƒè¦ç‚¹ï¼š
- æ¸¸æ ‡å¾ªç¯æ¨¡å¼ï¼šfetch â†’ æ£€æŸ¥done â†’ å¤„ç†æ•°æ®
- å¿…é¡»å…ˆfetchå†æ£€æŸ¥v_doneï¼ˆå¦åˆ™ä¼šæ¼æ‰æœ€åä¸€è¡Œï¼‰
- closeæ¸¸æ ‡é‡Šæ”¾èµ„æºï¼ˆè™½ç„¶è¿‡ç¨‹ç»“æŸä¼šè‡ªåŠ¨å…³é—­ï¼Œä½†æ˜¾å¼å…³é—­æ˜¯è§„èŒƒï¼‰
- æ¸¸æ ‡ä¸­çš„updateæ“ä½œåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
*/-- ============================================================================
-- ç¬¬äº”éƒ¨åˆ†ï¼šæ˜“é”™ç‚¹æ€»ç»“ï¼ˆè€ƒå‰å¿…çœ‹ï¼‰
-- ============================================================================
/*
ã€æ˜“é”™ç‚¹æ€»ç»“è¡¨ã€‘
+------+----------------------+------------------------+------------------------+
| ç¼–å· | æ˜“é”™ç‚¹               | é”™è¯¯ç¤ºä¾‹               | æ­£ç¡®å†™æ³•               |
+------+----------------------+------------------------+------------------------+
| 1    | returns vs return    | return int             | returns int (å£°æ˜)     |
|      |                      | begin returns x; end   | begin return x; end    |
+------+----------------------+------------------------+------------------------+
| 2    | outå‚æ•°è°ƒç”¨          | call proc(1, result);  | call proc(1, @result); |
+------+----------------------+------------------------+------------------------+
| 3    | å‡½æ•°å‚æ•°ç±»å‹         | create function f(     | å‡½æ•°åªèƒ½æœ‰inå‚æ•°       |
|      |                      |   out p int)           | ï¼ˆinå¯çœç•¥ï¼‰           |
+------+----------------------+------------------------+------------------------+
| 4    | sqlstateæ ¼å¼         | sqlstate 23000         | sqlstate '23000'       |
|      |                      |                        | ï¼ˆå¿…é¡»ç”¨å¼•å·ï¼‰         |
+------+----------------------+------------------------+------------------------+
| 5    | æ¸¸æ ‡handlerç±»å‹      | declare exit handler   | declare continue       |
|      |                      | for not found          | handler for not found  |
+------+----------------------+------------------------+------------------------+
| 6    | caseç»“æŸ             | case ...  end case      | case ... end           |
|      |                      |                        | ï¼ˆä¸æ˜¯end caseï¼‰       |
+------+----------------------+------------------------+------------------------+
| 7    | å£°æ˜é¡ºåº             | declare handler...      | å˜é‡â†’æ¸¸æ ‡â†’handler      |
|      |                      | declare cursor...      | â†’å¯æ‰§è¡Œè¯­å¥            |
+------+----------------------+------------------------+------------------------+
| 8    | æ¸¸æ ‡fetchæ—¶æœº        | if done then...        | fetchå…ˆæ‰§è¡Œ            |
|      |                      | fetch...                | å†æ£€æŸ¥doneæ ‡å¿—         |
+------+----------------------+------------------------+------------------------+
| 9    | rollbackä½œç”¨åŸŸ       | rollbackæ’¤é”€setè¯­å¥    | åªæ’¤é”€dmlæ“ä½œ          |
|      |                      |                        | ï¼ˆupdate/insertç­‰ï¼‰    |
+------+----------------------+------------------------+------------------------+
| 10   | å‡½æ•°ç‰¹æ€§ç»„åˆ         | deterministicä¸èƒ½ä¸    | å¯ä»¥åŒæ—¶ä½¿ç”¨           |
|      |                      | reads sql dataå…±å­˜     | ï¼ˆæ²¡æœ‰å†²çªï¼‰           |
+------+----------------------+------------------------+------------------------+
*/
/*
ã€å¿«é€Ÿè®°å¿†å£è¯€ã€‘
1. æœ‰så£°æ˜ï¼Œæ— sè¿”å›ï¼ˆreturns vs returnï¼‰
2. å‡½æ•°åªinï¼Œè¿‡ç¨‹ä¸‰ç§ï¼ˆin/out/inoutï¼‰
3. exitç«‹é€€ï¼Œcontinueç»§ç»­
4. æ¸¸æ ‡å¿…continueï¼Œç³»ç»Ÿç”¨exit
5. å˜é‡æ¸¸æ ‡å¤„ç†å™¨ï¼Œé¡ºåºä¸èƒ½ä¹±
6. fetchåœ¨å‰ï¼Œæ£€æŸ¥åœ¨å
7. äº‹åŠ¡åªæ’¤dmlï¼Œå˜é‡ä¸å›æ»š
8. 23000çº¦æŸé”™ï¼Œå¼•å·ä¸èƒ½å¿˜
*/
/*
ã€è€ƒè¯•æ—¶é—´åˆ†é…å»ºè®®ã€‘
- çœ‹é¢˜å®¡é¢˜ï¼š2åˆ†é’Ÿï¼ˆæ˜ç¡®è¦æ±‚ï¼šin/out/inoutã€å‡½æ•°/è¿‡ç¨‹ï¼‰
- å¡«å…³é”®è¯ï¼š3åˆ†é’Ÿï¼ˆå…ˆå¡«ç®€å•çš„ï¼šin/out/returns/returnï¼‰
- å¡«é€»è¾‘è¯ï¼š5åˆ†é’Ÿï¼ˆäº‹åŠ¡æ§åˆ¶ã€å¼‚å¸¸å¤„ç†ï¼‰
- æ£€æŸ¥è¯­æ³•ï¼š2åˆ†é’Ÿï¼ˆå¼•å·ã€é¡ºåºã€æ‹¼å†™ï¼‰
æ€»è®¡ï¼š12åˆ†é’Ÿ/é¢˜
*/
/*
ã€æ£€æŸ¥æ¸…å•ã€‘
â–¡ returnsæœ‰æ²¡æœ‰sï¼Ÿ
â–¡ returnæœ‰æ²¡æœ‰sï¼Ÿ
â–¡ outå‚æ•°è°ƒç”¨æ—¶æœ‰æ²¡æœ‰@ï¼Ÿ
â–¡ sqlstateæœ‰æ²¡æœ‰å¼•å·ï¼Ÿ
â–¡ æ¸¸æ ‡not foundç”¨çš„continueè¿˜æ˜¯exitï¼Ÿ
â–¡ caseç»“æŸæ˜¯endè¿˜æ˜¯end caseï¼Ÿ
â–¡ å£°æ˜é¡ºåºå¯¹ä¸å¯¹ï¼Ÿï¼ˆå˜é‡â†’æ¸¸æ ‡â†’handlerï¼‰
â–¡ äº‹åŠ¡æœ‰æ²¡æœ‰commit/rollbackï¼Ÿ
â–¡ æ¸¸æ ‡æœ‰æ²¡æœ‰closeï¼Ÿ
â–¡ å‡½æ•°æœ‰æ²¡æœ‰returnè¯­å¥ï¼Ÿ
*/-- ============================================================================
-- é™„å½•ï¼šå®Œæ•´å¯è¿è¡Œç¤ºä¾‹ï¼ˆä¾›æµ‹è¯•ç”¨ï¼‰
-- ============================================================================
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE
IF
  NOT EXISTS accounts ( id INT PRIMARY KEY, balance DECIMAL ( 10, 2 ) );
CREATE TABLE
IF
  NOT EXISTS users ( user_id INT PRIMARY KEY, points INT, balance DECIMAL ( 10, 2 ) );
CREATE TABLE
IF
  NOT EXISTS products ( product_id INT PRIMARY KEY, stock INT, point_price INT );-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO accounts
VALUES
  ( 1, 1000.00 ),
  ( 2, 500.00 );
INSERT INTO users
VALUES
  ( 1, 5000, 1000.00 ),
  ( 2, 200, 500.00 );
INSERT INTO products
VALUES
  ( 1, 10, 300 ),
  ( 2, 0, 500 );-- æµ‹è¯•è½¬è´¦å­˜å‚¨è¿‡ç¨‹
CALL transfer_money ( 1, 2, 100, @result );
SELECT
  @result;-- æµ‹è¯•ç§¯åˆ†å…‘æ¢å­˜å‚¨è¿‡ç¨‹
CALL exchange_product ( 1, 1, @STATUS, @msg );
SELECT
  @STATUS,
  @msg;-- ============================================================================
-- ç»“æŸè¯­
-- ============================================================================
/*
å¤ä¹ å®Œæˆæ£€æŸ¥è¡¨ï¼š
â–¡ å·²æŒæ¡å­˜å‚¨è¿‡ç¨‹ä¸‰ç§å‚æ•°ç±»å‹ï¼ˆin/out/inoutï¼‰
â–¡ å·²æŒæ¡å­˜å‚¨å‡½æ•°ç‰¹æ€§å£°æ˜ï¼ˆdeterministic/reads sql dataç­‰ï¼‰
â–¡ å·²æŒæ¡å¼‚å¸¸å¤„ç†å™¨ç±»å‹ï¼ˆexit/continueï¼‰
â–¡ å·²æŒæ¡å¼‚å¸¸ç±»å‹ï¼ˆsqlexception/not found/sqlstateï¼‰
â–¡ å·²æŒæ¡äº‹åŠ¡æ§åˆ¶ï¼ˆstart transaction/commit/rollbackï¼‰
â–¡ å·²æŒæ¡æ¸¸æ ‡äº”æ­¥èµ°ï¼ˆdeclare/open/fetch/loop/closeï¼‰
â–¡ å·²å®Œæˆ10é“å¡«ç©ºé¢˜ç»ƒä¹ 
â–¡ å·²é˜…è¯»æ˜“é”™ç‚¹æ€»ç»“

é¢„è®¡æŒæ¡ç¨‹åº¦ï¼š_____%
éœ€è¦é‡ç‚¹å¤ä¹ çš„éƒ¨åˆ†ï¼š__________

ç¥è€ƒè¯•é¡ºåˆ©ï¼ğŸ‰
*/